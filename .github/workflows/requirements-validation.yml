# Requirements Validation for Pull Requests
#
# This workflow validates requirements on PRs and generates diff reports.

name: Requirements Validation

on:
  pull_request:
    branches: [main]
    paths:
      - 'docs/requirements/**'
      - 'src/**'
      - 'include/**'
      - 'tests/**'
      - 'scripts/extract_code_requirements.py'
      - 'scripts/validate_requirements.py'
      - 'scripts/generate_requirement_diff.py'

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          pip install sphinx>=5.0 sphinx-needs>=0.6.0

      - name: Extract code requirements
        run: |
          python scripts/extract_code_requirements.py \
            --project-root . \
            --output build/code_references.json \
            --src-dirs src include \
            --test-dirs tests

      - name: Validate requirements (warning mode)
        id: validate_warnings
        run: |
          mkdir -p build
          python scripts/validate_requirements.py \
            --project-root . \
            --code-refs build/code_references.json \
            2>&1 | tee build/validation_report.txt
        continue-on-error: true

      - name: Validate requirements (strict mode)
        id: validate_strict
        run: |
          python scripts/validate_requirements.py \
            --project-root . \
            --code-refs build/code_references.json \
            --strict \
            --ci-mode \
            2>&1 | tee build/validation_strict.txt
        continue-on-error: true

      - name: Check spec requirement mappings
        id: check_spec
        run: |
          python scripts/check_spec_requirements.py \
            --project-root . \
            --output build/spec_mapping_report.md \
            2>&1 | tee build/spec_mapping.txt
        continue-on-error: true

      - name: Verify implementation status
        id: verify_impl
        run: |
          python scripts/verify_implementation_status.py \
            --project-root . \
            --code-refs build/code_references.json \
            --output build/implementation_verification.md \
            2>&1 | tee build/implementation_status.txt
        continue-on-error: true

      - name: Generate traceability matrix
        run: |
          mkdir -p build/docs/traceability
          python scripts/generate_traceability_matrix.py \
            --project-root . \
            --code-refs build/code_references.json \
            --output-dir build/docs/traceability \
            2>&1 | tee build/traceability.txt
        continue-on-error: true

      - name: Generate implementation report
        run: |
          python scripts/generate_implementation_report.py \
            --project-root . \
            --output build/docs/implementation_report.md \
            2>&1 | tee build/implementation_report.txt
        continue-on-error: true

      - name: Generate requirement diff
        run: |
          python scripts/generate_requirement_diff.py \
            --current docs/requirements \
            > build/requirement_diff.md

      - name: Create PR comment
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            let diffReport = '';
            try {
              diffReport = fs.readFileSync('build/requirement_diff.md', 'utf8');
            } catch (e) {
              diffReport = '*No requirement changes detected.*';
            }

            let validationReport = '';
            try {
              validationReport = fs.readFileSync('build/validation_report.txt', 'utf8');
            } catch (e) {
              validationReport = '*Validation report not available.*';
            }

            const body = `## Requirements Validation Report

            ${diffReport}

            <details>
            <summary>Validation Details</summary>

            \`\`\`
            ${validationReport}
            \`\`\`

            </details>
            `;

            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('Requirements Validation Report')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }

      - name: Upload validation artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: requirements-validation
          path: |
            build/code_references.json
            build/validation_report.txt
            build/validation_strict.txt
            build/spec_mapping_report.md
            build/implementation_verification.md
            build/requirement_diff.md
            build/docs/traceability/
            build/docs/implementation_report.md
          retention-days: 14

      - name: Check for traceability gaps
        run: |
          # Parse gap analysis to check for missing implementation or tests
          if [ -f "build/docs/traceability/gap_analysis.md" ]; then
            MISSING_IMPL=$(grep -c "^- REQ_" build/docs/traceability/gap_analysis.md | head -1 || echo "0")

            # Check if SWE.3 or SWE.6 failed
            if grep -q "SWE.3.*FAIL" build/docs/traceability/gap_analysis.md; then
              echo "::error::SWE.3 FAILED - Missing implementation for requirements"
              echo "See build/docs/traceability/gap_analysis.md for details"
              exit 1
            fi

            if grep -q "SWE.6.*FAIL" build/docs/traceability/gap_analysis.md; then
              echo "::error::SWE.6 FAILED - Missing test coverage for requirements"
              echo "See build/docs/traceability/gap_analysis.md for details"
              exit 1
            fi

            echo "::notice::ASPICE traceability validation passed"
          else
            echo "::warning::Gap analysis not generated - skipping traceability check"
          fi

          # Also fail if strict validation failed
          if [ "${{ steps.validate_strict.outcome }}" == "failure" ]; then
            echo "::error::Requirements validation failed in strict mode"
            echo "See validation_strict.txt for details"
            exit 1
          fi
